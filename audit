#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

run_step() {
  local label="$1"
  local folder="$2"
  shift 2

  echo ""
  echo "==> ${label}"
  (
    cd "${ROOT_DIR}/${folder}"
    "$@"
  )
}

run_step "Audit API (users)" "api" bun run typecheck
run_step "Audit API (users)" "api" bun test
run_step "Audit API Proxy" "apimuslim-proxy" bun run typecheck
run_step "Audit API Proxy" "apimuslim-proxy" bun test
run_step "Audit Web (unit)" "web" npm run test
run_step "Audit Web (typecheck)" "web" npx tsc --noEmit
run_step "Audit Web (build)" "web" npm run build
run_step "Audit Web (visual)" "web" npm run test:visual
run_step "Audit Web (pwa)" "web" npm run test:pwa

echo ""
echo "Audit selesai tanpa error."
